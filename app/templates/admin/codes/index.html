{% extends "base.html" %}

{% block title %}CDKç®¡ç† - GPT Team ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="page-header">
    <h2>CDKç®¡ç†</h2>
</div>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-container">
    <div class="stat-card">
        <div class="stat-icon">ğŸ«</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">å…‘æ¢ç æ€»æ•°</div>
        </div>
    </div>
    <div class="stat-card stat-success">
        <div class="stat-icon">âœ…</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.unused }}</div>
            <div class="stat-label">æœªä½¿ç”¨</div>
        </div>
    </div>
    <div class="stat-card stat-info">
        <div class="stat-icon">ğŸ“</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.used }}</div>
            <div class="stat-label">å·²ä½¿ç”¨</div>
        </div>
    </div>
    <div class="stat-card stat-danger">
        <div class="stat-icon">â°</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.expired }}</div>
            <div class="stat-label">å·²è¿‡æœŸ</div>
        </div>
    </div>
</div>

<!-- æ“ä½œæ  -->
<div class="section-header toolbar">
    <div>
        <div class="filter-and-search">
            <div class="filter-buttons">
                <button onclick="filterByStatus('all')" class="btn btn-sm btn-secondary active" id="filter-all">å…¨éƒ¨</button>
                <button onclick="filterByStatus('unused')" class="btn btn-sm btn-success" id="filter-unused">æœªä½¿ç”¨</button>
                <button onclick="filterByStatus('used')" class="btn btn-sm btn-info" id="filter-used">å·²ä½¿ç”¨</button>
                <button onclick="filterByStatus('expired')" class="btn btn-sm btn-danger" id="filter-expired">å·²è¿‡æœŸ</button>
            </div>

            <form action="{{ admin_path }}/codes" method="get" class="search-form">
                <div class="search-input-group">
                    <input type="text" name="search" value="{{ search or '' }}" placeholder="æœç´¢å…‘æ¢ç æˆ–é‚®ç®±..." class="btn-sm">
                    <button type="submit" class="btn btn-sm btn-secondary">
                        <i data-lucide="search" style="width: 14px; height: 14px;"></i>
                    </button>
                    {% if search %}
                    <a href="{{ admin_path }}/codes" class="btn btn-sm btn-danger" title="æ¸…é™¤æœç´¢">
                        <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
        <div class="selection-count" id="codeSelectionCount">å·²é€‰æ‹© 0 é¡¹</div>
    </div>
    <div class="action-buttons">
        <button onclick="bulkDeleteCodes()" class="btn btn-danger" id="bulkDeleteCodesBtn" disabled>æ‰¹é‡åˆ é™¤</button>
        <button onclick="showModal('generateCodeModal')" class="btn btn-primary">ç”Ÿæˆå…‘æ¢ç </button>
        <button onclick="exportCodes()" class="btn btn-secondary">å¯¼å‡ºå…‘æ¢ç </button>
    </div>
</div>

<!-- å…‘æ¢ç åˆ—è¡¨ -->
<div class="content-section">
    {% if codes %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th class="table-check">
                        <input type="checkbox" id="selectAllCodes" aria-label="å…¨é€‰å…‘æ¢ç ">
                    </th>
                    <th>å…‘æ¢ç </th>
                    <th>çŠ¶æ€</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>è¿‡æœŸæ—¶é—´</th>
                    <th>ä½¿ç”¨è€…é‚®ç®±</th>
                    <th>è®ºå›ç”¨æˆ·</th>
                    <th>ä½¿ç”¨æ—¶é—´</th>
                    <th style="text-align: right;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="codesTableBody">
                {% for code in codes %}
                <tr data-status="{{ code.status }}">
                    <td class="table-check">
                        <input type="checkbox" class="code-select" value="{{ code.code }}" aria-label="é€‰æ‹©å…‘æ¢ç  {{ code.code }}">
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="ticket" style="width: 14px; height: 14px; color: var(--text-muted);"></i>
                            <code>{{ code.code }}</code>
                        </div>
                    </td>
                    <td>
                        {% if code.status == 'unused' %}
                        <span class="status-badge status-active">æœªä½¿ç”¨</span>
                        {% elif code.status == 'used' %}
                        <span class="status-badge status-full">å·²ä½¿ç”¨</span>
                        {% elif code.status == 'expired' %}
                        <span class="status-badge status-error">å·²è¿‡æœŸ</span>
                        {% endif %}
                    </td>
                    <td>{{ code.created_at }}</td>
                    <td>{{ code.expires_at if code.expires_at else 'æ°¸ä¹…æœ‰æ•ˆ' }}</td>
                    <td>{{ code.used_by_email if code.used_by_email else '-' }}</td>
                    <td>
                        {% if code.oauth_username %}
                        <a href="https://linux.do/u/{{ code.oauth_username }}/summary" target="_blank" rel="noreferrer" class="forum-user">
                            {% if code.oauth_avatar_template %}
                            {% set avatar_url = code.oauth_avatar_template.replace('{size}', '64') %}
                            <img src="{% if avatar_url.startswith('http') %}{{ avatar_url }}{% else %}https://linux.do{{ avatar_url }}{% endif %}" alt="{{ code.oauth_username }}" onerror="this.onerror=null;this.src='{{ request.app.url_path_for('static', path='img/default-avatar.svg') }}?v={{ static_version }}';">
                            {% else %}
                            <img src="{{ request.app.url_path_for('static', path='img/default-avatar.svg') }}?v={{ static_version }}" alt="{{ code.oauth_username }}">
                            {% endif %}
                            <span>{{ code.oauth_username }}</span>
                        </a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>{{ code.used_at if code.used_at else '-' }}</td>
                    <td style="text-align: right;">
                        <div class="action-buttons" style="justify-content: flex-end;">
                            <button onclick="copyCode('{{ code.code }}')" class="btn btn-sm btn-secondary" title="å¤åˆ¶">
                                <i data-lucide="copy"></i>
                            </button>
                            {% if code.status == 'unused' %}
                            <button onclick="deleteCode('{{ code.code }}')" class="btn btn-sm btn-danger" title="åˆ é™¤">
                                <i data-lucide="trash-2"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- åˆ†é¡µ -->
    {% if pagination.total_pages > 1 %}
    <div class="pagination">
        {% set search_param = '&search=' + search if search else '' %}

        {% if pagination.current_page > 1 %}
        <a href="?page=1{{ search_param }}" class="btn btn-sm btn-secondary">é¦–é¡µ</a>
        <a href="?page={{ pagination.current_page - 1 }}{{ search_param }}" class="btn btn-sm btn-secondary">
            <i data-lucide="chevron-left" style="width: 14px; height: 14px;"></i>
        </a>
        {% endif %}

        <span class="pagination-info">ç¬¬ {{ pagination.current_page }} / {{ pagination.total_pages }} é¡µ</span>

        {% if pagination.current_page < pagination.total_pages %} <a
            href="?page={{ pagination.current_page + 1 }}{{ search_param }}" class="btn btn-sm btn-secondary">
            <i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i>
            </a>
            <a href="?page={{ pagination.total_pages }}{{ search_param }}" class="btn btn-sm btn-secondary">æœ«é¡µ</a>
            {% endif %}
    </div>
    {% endif %}
    {% else %}
    <div class="empty-state">
        <i data-lucide="package-open" style="width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.2;"></i>
        <p>æš‚æ— å…‘æ¢ç æ•°æ®</p>
        <button onclick="showModal('generateCodeModal')" class="btn btn-primary">ç«‹å³ç”Ÿæˆ</button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
    .filter-and-search {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .section-header.toolbar {
        align-items: center;
    }

    .section-header.toolbar .action-buttons {
        margin-left: auto;
    }

    .search-input-group {
        display: flex;
        align-items: center;
        background: rgba(6, 10, 18, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 999px;
        padding: 6px;
        min-width: 320px;
        gap: 6px;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
    }

    .search-input-group input {
        border: none;
        background: transparent;
        padding: 0.45rem 0.9rem;
        outline: none;
        color: var(--text-main);
        min-width: 220px;
        font-size: 0.9rem;
    }

    .search-input-group .btn {
        padding: 0.45rem 0.65rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text-main);
        transition: all 0.2s ease;
        margin-left: auto;
    }

    .data-table .action-buttons {
        display: inline-flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.5rem;
        flex-wrap: nowrap;
    }

    .search-input-group .btn:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .search-input-group input::placeholder {
        color: var(--text-muted);
        opacity: 0.65;
    }

    .search-input-group:focus-within {
        border-color: rgba(34, 193, 184, 0.55);
        box-shadow: 0 0 0 3px rgba(34, 193, 184, 0.18);
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1.5rem;
        padding: 1rem;
    }

    .pagination-info {
        margin: 0 1rem;
        font-size: 0.9rem;
        color: var(--text-muted);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // å½“å‰ç­›é€‰çŠ¶æ€
    let currentFilter = 'all';

    function getSelectedCodes() {
        return Array.from(document.querySelectorAll('.code-select:checked')).map((input) => input.value);
    }

    function updateBulkState() {
        const selected = getSelectedCodes();
        const bulkDeleteBtn = document.getElementById('bulkDeleteCodesBtn');
        const selectionCount = document.getElementById('codeSelectionCount');
        const selectAll = document.getElementById('selectAllCodes');
        const total = document.querySelectorAll('.code-select').length;

        if (bulkDeleteBtn) {
            bulkDeleteBtn.disabled = selected.length === 0;
        }

        if (selectionCount) {
            selectionCount.textContent = `å·²é€‰æ‹© ${selected.length} é¡¹`;
        }

        if (selectAll) {
            selectAll.checked = selected.length > 0 && selected.length === total;
            selectAll.indeterminate = selected.length > 0 && selected.length < total;
        }
    }

    function bindCodeSelection() {
        const selectAll = document.getElementById('selectAllCodes');
        const checkboxes = document.querySelectorAll('.code-select');

        if (selectAll) {
            selectAll.addEventListener('change', () => {
                checkboxes.forEach((checkbox) => {
                    checkbox.checked = selectAll.checked;
                });
                updateBulkState();
            });
        }

        checkboxes.forEach((checkbox) => {
            checkbox.addEventListener('change', updateBulkState);
        });

        updateBulkState();
    }

    // æŒ‰çŠ¶æ€ç­›é€‰
    function filterByStatus(status) {
        currentFilter = status;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.filter-buttons .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`filter-${status}`).classList.add('active');

        // ç­›é€‰è¡¨æ ¼è¡Œ
        const rows = document.querySelectorAll('#codesTableBody tr');
        rows.forEach(row => {
            const rowStatus = row.getAttribute('data-status');
            if (status === 'all' || rowStatus === status) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    async function bulkDeleteCodes() {
        const codes = getSelectedCodes();
        if (codes.length === 0) {
            showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å…‘æ¢ç ', 'error');
            return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤æ‰€é€‰çš„ ${codes.length} ä¸ªå…‘æ¢ç å—?`)) {
            return;
        }

        try {
            const response = await fetch(`{{ admin_path }}/codes/bulk-delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ codes })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showToast(`å·²åˆ é™¤ ${result.success_count || codes.length} ä¸ªå…‘æ¢ç `, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                const successCount = result.success_count || 0;
                if (successCount > 0) {
                    showToast(`éƒ¨åˆ†åˆ é™¤æˆåŠŸ (${successCount}/${codes.length})ï¼Œè¯·åˆ·æ–°æŸ¥çœ‹`, 'info');
                } else {
                    showToast(result.error || 'æ‰¹é‡åˆ é™¤å¤±è´¥', 'error');
                }
            }
        } catch (error) {
            showToast('ç½‘ç»œé”™è¯¯', 'error');
        }
    }

    // åˆ é™¤å…‘æ¢ç 
    async function deleteCode(code) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤å…‘æ¢ç  ${code} å—?`)) {
            return;
        }

        try {
            const response = await fetch(`{{ admin_path }}/codes/${encodeURIComponent(code)}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showToast('åˆ é™¤æˆåŠŸ', 'success');
                // åˆ·æ–°é¡µé¢
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast(result.error || 'åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (error) {
            showToast('ç½‘ç»œé”™è¯¯', 'error');
        }
    }


    // å¯¼å‡ºå…‘æ¢ç 
    async function exportCodes() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const search = urlParams.get('search') || '';
            const exportUrl = `{{ admin_path }}/codes/export${search ? '?search=' + encodeURIComponent(search) : ''}`;

            const response = await fetch(exportUrl);

            if (response.ok) {
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `redemption_codes_${new Date().getTime()}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('å¯¼å‡ºæˆåŠŸ', 'success');
            } else {
                showToast('å¯¼å‡ºå¤±è´¥', 'error');
            }
        } catch (error) {
            showToast('ç½‘ç»œé”™è¯¯', 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', bindCodeSelection);
</script>
{% endblock %}
